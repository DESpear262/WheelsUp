# WheelsUp CI/CD Setup

This document explains how to configure the CI/CD pipelines for the WheelsUp project.

## GitHub Actions Workflows

### Build Workflow (`.github/workflows/build.yml`)
- **Trigger**: Push/PR to `main` branch
- **Purpose**: Lint, type-check, unit test, and build the application
- **Services**: PostgreSQL and OpenSearch for testing
- **Artifacts**: Uploads build artifacts for deployment

### Deploy Workflow (`.github/workflows/deploy.yml`)
- **Trigger**: Push to `main` branch (manual trigger also available)
- **Purpose**: Build Docker images, push to ECR, deploy to EC2
- **Notifications**: Email notifications on deployment status

## Required GitHub Secrets

Configure these secrets in your GitHub repository settings:

### AWS Configuration
- `AWS_ACCESS_KEY_ID`: AWS access key for ECR and EC2 access
- `AWS_SECRET_ACCESS_KEY`: AWS secret key
- `AWS_REGION`: AWS region (e.g., `us-east-1`)

### EC2 Deployment
- `EC2_HOST`: EC2 instance public IP or DNS name
- `EC2_USER`: SSH username (usually `ubuntu` for Ubuntu instances)
- `EC2_SSH_KEY`: Private SSH key for EC2 access
- `EC2_PORT`: SSH port (default: `22`)

### Application Environment
- `DATABASE_URL`: PostgreSQL connection string
- `OPENSEARCH_URL`: OpenSearch endpoint URL
- `NEXT_PUBLIC_MAPBOX_TOKEN`: Mapbox API token
- `ANTHROPIC_API_KEY`: Anthropic Claude API key
- `OPENAI_API_KEY`: OpenAI API key

### Email Notifications
- `EMAIL_USERNAME`: SMTP email address (e.g., Gmail)
- `EMAIL_PASSWORD`: SMTP password or app password
- `NOTIFICATION_EMAIL`: Email address to receive notifications

### ECR Configuration
- `ECR_REGISTRY`: ECR registry URL (auto-generated by workflow)

## EC2 Setup Requirements

### 1. Install Dependencies
```bash
# Update system
sudo apt update && sudo apt upgrade -y

# Install Docker and Docker Compose
sudo apt install -y docker.io docker-compose
sudo systemctl enable docker
sudo systemctl start docker

# Add user to docker group
sudo usermod -aG docker ubuntu

# Install AWS CLI
sudo apt install -y awscli

# Install Git
sudo apt install -y git
```

### 2. Clone Repository
```bash
cd /home/ubuntu
git clone https://github.com/your-org/wheelsup.git
cd wheelsup
```

### 3. Configure AWS CLI (optional, for manual operations)
```bash
aws configure
# Enter your AWS credentials
```

### 4. Create Docker Compose Override (if needed)
```bash
# Copy docker-compose.prod.yml if you have production-specific config
cp docker-compose.override.yml docker-compose.prod.yml
# Edit as needed for production settings
```

## Workflow Execution

### Automatic Triggers
- **Build**: Runs on every push to `main` and pull requests
- **Deploy**: Runs automatically on successful push to `main`

### Manual Triggers
- Deploy can be triggered manually via GitHub Actions UI

### Monitoring
- Check GitHub Actions tab for workflow status
- Email notifications sent on deployment completion/failure
- Docker logs available on EC2: `docker-compose logs`

## Troubleshooting

### Common Issues

1. **SSH Connection Failed**
   - Verify EC2 security group allows SSH (port 22)
   - Check SSH key permissions: `chmod 600 ~/.ssh/id_rsa`
   - Ensure EC2 instance is running

2. **Docker Build Failed**
   - Check EC2 has sufficient disk space
   - Verify AWS ECR permissions
   - Check Docker daemon is running: `sudo systemctl status docker`

3. **Application Won't Start**
   - Check environment variables in `.env` file
   - Verify database and OpenSearch connectivity
   - Check Docker Compose logs: `docker-compose logs web`

4. **Email Notifications Not Working**
   - For Gmail: Enable 2FA and create app password
   - Verify SMTP settings (Gmail uses smtp.gmail.com:465)

### Logs and Debugging
```bash
# View deployment logs
docker-compose logs -f

# Check service health
docker-compose ps

# Restart services
docker-compose restart

# View application logs
docker-compose logs web
docker-compose logs etl
```

## Security Considerations

- SSH keys should be generated specifically for CI/CD
- AWS credentials should follow principle of least privilege
- Environment variables contain sensitive data - never commit to repository
- Regular rotation of access keys and SSH keys recommended
